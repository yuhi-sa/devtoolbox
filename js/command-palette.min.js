"use strict";

(function () {
  /* ================================
     コマンドパレット (Cmd+K / Ctrl+K)
     ================================ */

  var TOOLS = [
    { name: "JSON整形・検証", slug: "json-formatter", keywords: "JSON 整形 検証 フォーマット pretty print", category: "フォーマット" },
    { name: "SQLフォーマッター", slug: "sql-formatter", keywords: "SQL フォーマット 整形 クエリ", category: "フォーマット" },
    { name: "XMLフォーマッター", slug: "xml-formatter", keywords: "XML フォーマット 整形", category: "フォーマット" },
    { name: "Markdownプレビュー", slug: "markdown-preview", keywords: "Markdown プレビュー マークダウン", category: "フォーマット" },
    { name: "SVGオプティマイザー", slug: "svg-optimizer", keywords: "SVG 最適化 軽量化", category: "フォーマット" },
    { name: "CSSミニファイ/整形", slug: "css-minifier", keywords: "CSS ミニファイ 圧縮 minify beautify", category: "フォーマット" },
    { name: "JSミニファイ/整形", slug: "js-minifier", keywords: "JavaScript JS ミニファイ 圧縮", category: "フォーマット" },
    { name: "HTMLミニファイ/整形", slug: "html-minifier", keywords: "HTML ミニファイ 圧縮", category: "フォーマット" },
    { name: "Base64エンコード/デコード", slug: "base64", keywords: "Base64 エンコード デコード encode decode", category: "エンコード" },
    { name: "URLエンコード/デコード", slug: "url-encode", keywords: "URL エンコード デコード encode decode", category: "エンコード" },
    { name: "HTMLエンティティ変換", slug: "html-entity", keywords: "HTML エンティティ entity 特殊文字", category: "エンコード" },
    { name: "画像Base64変換", slug: "image-base64", keywords: "画像 image Base64 変換 data URL", category: "エンコード" },
    { name: "エスケープ変換", slug: "backslash-escape", keywords: "バックスラッシュ エスケープ backslash", category: "エンコード" },
    { name: "文字列エスケープ変換", slug: "string-escape", keywords: "文字列 エスケープ string escape", category: "エンコード" },
    { name: "文字数カウンター", slug: "char-counter", keywords: "文字数 カウンター 行数 バイト数", category: "テキスト" },
    { name: "正規表現テスター", slug: "regex-tester", keywords: "正規表現 regex テスト パターン", category: "テキスト" },
    { name: "正規表現チートシート", slug: "regex-cheatsheet", keywords: "正規表現 regex チートシート リファレンス", category: "テキスト" },
    { name: "テキスト差分比較", slug: "diff-checker", keywords: "テキスト 差分 比較 diff", category: "テキスト" },
    { name: "テキストケース変換", slug: "text-case", keywords: "テキスト ケース 変換 大文字 小文字 camelCase", category: "テキスト" },
    { name: "HTML→Markdown変換", slug: "html-to-markdown", keywords: "HTML Markdown 変換", category: "テキスト" },
    { name: "Lorem Ipsumジェネレーター", slug: "lorem-ipsum", keywords: "Lorem Ipsum ダミーテキスト", category: "テキスト" },
    { name: "スラッグ生成", slug: "slug-generator", keywords: "スラッグ slug URL", category: "テキスト" },
    { name: "文字数・単語カウンター", slug: "word-counter", keywords: "文字数 単語 カウント word count", category: "テキスト" },
    { name: "テキスト→HTML変換", slug: "text-to-html", keywords: "テキスト HTML 変換", category: "テキスト" },
    { name: "YAML⇔JSON変換", slug: "yaml-json", keywords: "YAML JSON 変換", category: "変換" },
    { name: "CSV⇔JSON変換", slug: "csv-json", keywords: "CSV JSON 変換", category: "変換" },
    { name: "JSON→CSV変換", slug: "json-to-csv", keywords: "JSON CSV 変換 ダウンロード", category: "変換" },
    { name: "TOML⇔JSON変換", slug: "toml-json", keywords: "TOML JSON 変換", category: "変換" },
    { name: "JSON→TypeScript変換", slug: "json-to-typescript", keywords: "JSON TypeScript 型定義 interface", category: "変換" },
    { name: "JSONパスファインダー", slug: "json-path", keywords: "JSON パス path finder", category: "変換" },
    { name: "JSONスキーマバリデーター", slug: "json-schema-validator", keywords: "JSON スキーマ schema バリデーション", category: "変換" },
    { name: "Unixタイムスタンプ変換", slug: "timestamp", keywords: "Unix タイムスタンプ timestamp epoch 日時", category: "変換" },
    { name: "カラーコンバーター", slug: "color-converter", keywords: "カラー color 色 HEX RGB HSL", category: "変換" },
    { name: "進数変換ツール", slug: "number-base", keywords: "進数 変換 2進数 8進数 16進数 10進数", category: "変換" },
    { name: "バイト単位変換", slug: "byte-converter", keywords: "バイト byte KB MB GB TB 単位", category: "変換" },
    { name: "ハッシュ生成", slug: "hash-generator", keywords: "ハッシュ hash MD5 SHA256 SHA512", category: "生成" },
    { name: "UUID生成", slug: "uuid-generator", keywords: "UUID GUID 生成 ユニークID", category: "生成" },
    { name: "パスワード生成", slug: "password-generator", keywords: "パスワード password 生成 ランダム", category: "生成" },
    { name: "QRコード生成", slug: "qr-code", keywords: "QRコード QR code 生成", category: "生成" },
    { name: "カラーパレット生成", slug: "color-palette", keywords: "カラーパレット color palette 配色", category: "デザイン" },
    { name: "プレースホルダー画像生成", slug: "placeholder-image", keywords: "プレースホルダー 画像 placeholder ダミー", category: "生成" },
    { name: "CSSグラデーション生成", slug: "css-gradient", keywords: "CSS グラデーション gradient 背景", category: "CSS" },
    { name: "Box Shadow生成", slug: "box-shadow", keywords: "CSS box-shadow ボックスシャドウ 影", category: "CSS" },
    { name: "Flexboxプレイグラウンド", slug: "flexbox-playground", keywords: "CSS Flexbox フレックス レイアウト", category: "CSS" },
    { name: "Border Radius生成", slug: "border-radius", keywords: "CSS border-radius 角丸", category: "CSS" },
    { name: "CSSグリッドジェネレーター", slug: "css-grid-generator", keywords: "CSS Grid グリッド レイアウト", category: "CSS" },
    { name: "SVGオプティマイザー", slug: "svg-optimizer", keywords: "SVG 最適化 軽量化 アイコン", category: "フォーマット" },
    { name: "画像圧縮", slug: "image-compressor", keywords: "画像 圧縮 image compress リサイズ", category: "画像" },
    { name: "JWTデコーダー", slug: "jwt-decoder", keywords: "JWT トークン token デコード decode", category: "開発" },
    { name: "JWTジェネレーター", slug: "jwt-generator", keywords: "JWT トークン token 生成 generator", category: "開発" },
    { name: "Cron式パーサー", slug: "cron-parser", keywords: "Cron クーロン 式 パーサー スケジュール", category: "開発" },
    { name: "Crontabジェネレーター", slug: "crontab-generator", keywords: "Crontab クーロン 生成 スケジュール", category: "開発" },
    { name: "Chmod計算機", slug: "chmod-calculator", keywords: "chmod パーミッション permission 権限 755", category: "開発" },
    { name: "HTTPステータスコード", slug: "http-status", keywords: "HTTP ステータスコード status code 200 404", category: "開発" },
    { name: ".gitignore生成", slug: "gitignore-generator", keywords: "gitignore git 生成 テンプレート", category: "開発" },
    { name: "メタタグ生成", slug: "meta-tag-generator", keywords: "メタタグ meta tag SEO OGP", category: "SEO" },
    { name: "OGPプレビュー", slug: "og-preview", keywords: "OGP Open Graph プレビュー SNS", category: "SEO" },
    { name: "OGPテスター", slug: "og-tester", keywords: "OGP Open Graph テスター 検証", category: "SEO" },
    { name: "Robots.txtジェネレーター", slug: "robots-generator", keywords: "robots.txt ロボット クローラー SEO", category: "SEO" },
    { name: "アスペクト比計算機", slug: "aspect-ratio", keywords: "アスペクト比 aspect ratio 画面 解像度", category: "変換" },
    // Tools batch 2 (70 total)
    { name: "JSON差分比較", slug: "json-diff", keywords: "JSON 差分 比較 diff 差異", category: "変換" },
    { name: "Markdownテーブル生成", slug: "markdown-table", keywords: "Markdown テーブル table 表 生成", category: "テキスト" },
    { name: "CSSアニメーション生成", slug: "css-animation", keywords: "CSS アニメーション animation keyframes 動き", category: "CSS" },
    { name: "テキスト⇔バイナリ変換", slug: "text-binary", keywords: "テキスト バイナリ binary 16進数 hex 2進数", category: "エンコード" },
    { name: "行ソート・重複削除", slug: "line-sort", keywords: "行 ソート sort 重複 削除 deduplicate", category: "テキスト" },
    { name: "IPアドレス・サブネット計算", slug: "ip-calculator", keywords: "IP アドレス サブネット subnet CIDR ネットワーク", category: "開発" },
    { name: "cURLコマンド変換", slug: "curl-converter", keywords: "cURL curl コマンド 変換 Python JavaScript fetch", category: "開発" },
    { name: "ファビコン生成", slug: "favicon-generator", keywords: "ファビコン favicon アイコン icon 生成", category: "生成" },
    { name: "CSS単位変換", slug: "css-unit-converter", keywords: "CSS 単位 px rem em vw vh 変換", category: "CSS" },
    { name: "日時計算", slug: "datetime-calc", keywords: "日時 日付 時間 計算 差分 date time", category: "変換" },
    { name: "テストデータ生成", slug: "random-data", keywords: "テストデータ ランダム random ダミー 名前 メール", category: "生成" },
    { name: "AIトークンカウンター", slug: "token-counter", keywords: "トークン token カウンター GPT Claude LLM AI", category: "開発" },
    { name: "HTMLプレビュー", slug: "html-preview", keywords: "HTML プレビュー preview ライブ", category: "開発" },
    { name: "JSON→Go構造体変換", slug: "json-to-go", keywords: "JSON Go 構造体 struct 変換", category: "変換" },
    { name: "YAMLバリデーター", slug: "yaml-validator", keywords: "YAML バリデーション 検証 validate", category: "フォーマット" },
    { name: "Markdown→HTML変換", slug: "markdown-to-html", keywords: "Markdown HTML 変換 マークダウン", category: "変換" },
    { name: "Unicode検索・変換", slug: "unicode-lookup", keywords: "Unicode ユニコード 文字 コードポイント UTF-8", category: "テキスト" },
    { name: "Docker Compose生成", slug: "docker-compose-generator", keywords: "Docker Compose ドッカー コンテナ YAML", category: "生成" },
    { name: "Nginx設定生成", slug: "nginx-config-generator", keywords: "Nginx エンジンエックス 設定 config リバースプロキシ", category: "生成" },
    { name: ".env生成・管理", slug: "env-generator", keywords: "env 環境変数 dotenv シークレット", category: "生成" },
    { name: "OpenAPI/Swaggerエディター", slug: "openapi-editor", keywords: "OpenAPI Swagger API エディター REST", category: "開発" },
    { name: "SQL→JSON変換", slug: "sql-to-json", keywords: "SQL JSON 変換 テーブル スキーマ", category: "変換" },
    { name: "CSSセレクターテスター", slug: "css-selector-tester", keywords: "CSS セレクター selector テスト querySelector", category: "CSS" },
    { name: "正規表現ジェネレーター", slug: "regex-generator", keywords: "正規表現 regex 生成 パターン ジェネレーター", category: "テキスト" },
    { name: "HTTPヘッダー確認", slug: "http-header-viewer", keywords: "HTTP ヘッダー header リクエスト レスポンス", category: "開発" },
    { name: "DNS検索ツール", slug: "dns-lookup", keywords: "DNS ドメイン レコード ゾーン ネームサーバー", category: "開発" }
  ];

  // Remove duplicates (svg-optimizer appears twice)
  var seen = {};
  TOOLS = TOOLS.filter(function(t) {
    if (seen[t.slug]) return false;
    seen[t.slug] = true;
    return true;
  });

  var palette = null;
  var input = null;
  var list = null;
  var selectedIndex = 0;
  var filteredTools = [];
  var isOpen = false;

  function getBasePath() {
    var path = window.location.pathname;
    if (path.indexOf("/tools/") !== -1) {
      return "../../tools/";
    }
    return "tools/";
  }

  function createPalette() {
    if (palette) return;

    var overlay = document.createElement("div");
    overlay.className = "cmd-palette-overlay";
    overlay.addEventListener("click", function (e) {
      if (e.target === overlay) closePalette();
    });

    palette = document.createElement("div");
    palette.className = "cmd-palette";
    palette.setAttribute("role", "dialog");
    palette.setAttribute("aria-label", "ツール検索");

    var header = document.createElement("div");
    header.className = "cmd-palette__header";

    var icon = document.createElement("span");
    icon.className = "cmd-palette__icon";
    icon.innerHTML = '<svg viewBox="0 0 20 20" width="20" height="20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>';

    input = document.createElement("input");
    input.type = "text";
    input.className = "cmd-palette__input";
    input.placeholder = "ツール名を入力して検索...";
    input.setAttribute("autocomplete", "off");
    input.setAttribute("spellcheck", "false");

    var shortcutHint = document.createElement("span");
    shortcutHint.className = "cmd-palette__shortcut";
    shortcutHint.textContent = "ESC";

    header.appendChild(icon);
    header.appendChild(input);
    header.appendChild(shortcutHint);

    list = document.createElement("div");
    list.className = "cmd-palette__list";
    list.setAttribute("role", "listbox");

    palette.appendChild(header);
    palette.appendChild(list);
    overlay.appendChild(palette);
    document.body.appendChild(overlay);

    input.addEventListener("input", function () {
      filterTools(input.value.trim().toLowerCase());
    });

    input.addEventListener("keydown", function (e) {
      if (e.key === "ArrowDown") {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, filteredTools.length - 1);
        updateSelection();
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        updateSelection();
      } else if (e.key === "Enter") {
        e.preventDefault();
        if (filteredTools[selectedIndex]) {
          navigateToTool(filteredTools[selectedIndex].slug);
        }
      } else if (e.key === "Escape") {
        closePalette();
      }
    });
  }

  function fuzzyMatch(text, query) {
    if (!query) return { match: true, score: 0 };
    text = text.toLowerCase();
    query = query.toLowerCase();

    // Exact substring match (highest priority)
    if (text.indexOf(query) !== -1) {
      return { match: true, score: text.indexOf(query) === 0 ? 100 : 80 };
    }

    // Fuzzy character matching
    var qi = 0;
    var consecutive = 0;
    var maxConsecutive = 0;
    var score = 0;

    for (var ti = 0; ti < text.length && qi < query.length; ti++) {
      if (text[ti] === query[qi]) {
        qi++;
        consecutive++;
        if (consecutive > maxConsecutive) maxConsecutive = consecutive;
        score += consecutive; // Bonus for consecutive matches
      } else {
        consecutive = 0;
      }
    }

    if (qi === query.length) {
      return { match: true, score: score + maxConsecutive * 10 };
    }

    return { match: false, score: 0 };
  }

  function filterTools(query) {
    selectedIndex = 0;

    if (!query) {
      // Show recent tools first, then all
      var recent = [];
      try {
        recent = JSON.parse(localStorage.getItem("devtoolbox-recent") || "[]");
      } catch (e) {}

      var recentSet = {};
      recent.forEach(function (slug) { recentSet[slug] = true; });

      filteredTools = [];
      // Add recent tools first
      TOOLS.forEach(function (t) {
        if (recentSet[t.slug]) {
          filteredTools.push(Object.assign({}, t, { isRecent: true }));
        }
      });
      // Then add rest
      TOOLS.forEach(function (t) {
        if (!recentSet[t.slug]) {
          filteredTools.push(t);
        }
      });
    } else {
      var scored = [];
      TOOLS.forEach(function (t) {
        var nameMatch = fuzzyMatch(t.name, query);
        var keywordMatch = fuzzyMatch(t.keywords, query);
        var categoryMatch = fuzzyMatch(t.category, query);
        var bestScore = Math.max(nameMatch.score, keywordMatch.score * 0.7, categoryMatch.score * 0.5);
        if (nameMatch.match || keywordMatch.match || categoryMatch.match) {
          scored.push({ tool: t, score: bestScore });
        }
      });

      scored.sort(function (a, b) { return b.score - a.score; });
      filteredTools = scored.map(function (s) { return s.tool; });
    }

    renderList(query);
  }

  function highlightMatch(text, query) {
    if (!query) return text;
    var lower = text.toLowerCase();
    var idx = lower.indexOf(query.toLowerCase());
    if (idx === -1) return text;
    return text.substring(0, idx) +
      '<mark class="cmd-palette__highlight">' +
      text.substring(idx, idx + query.length) +
      '</mark>' +
      text.substring(idx + query.length);
  }

  function renderList(query) {
    list.innerHTML = "";

    if (filteredTools.length === 0) {
      var empty = document.createElement("div");
      empty.className = "cmd-palette__empty";
      empty.textContent = "該当するツールが見つかりません";
      list.appendChild(empty);
      return;
    }

    var max = Math.min(filteredTools.length, 12);
    for (var i = 0; i < max; i++) {
      var tool = filteredTools[i];
      var item = document.createElement("div");
      item.className = "cmd-palette__item" + (i === selectedIndex ? " is-selected" : "");
      item.setAttribute("role", "option");
      item.setAttribute("data-index", String(i));

      var nameHtml = highlightMatch(tool.name, query || "");
      item.innerHTML =
        '<span class="cmd-palette__item-category">' + tool.category + '</span>' +
        '<span class="cmd-palette__item-name">' + nameHtml + '</span>' +
        (tool.isRecent ? '<span class="cmd-palette__item-badge">最近</span>' : '') +
        '<span class="cmd-palette__item-arrow">&rarr;</span>';

      (function (slug) {
        item.addEventListener("click", function () {
          navigateToTool(slug);
        });
      })(tool.slug);

      item.addEventListener("mouseenter", function () {
        var idx = parseInt(this.getAttribute("data-index"), 10);
        selectedIndex = idx;
        updateSelection();
      });

      list.appendChild(item);
    }

    if (filteredTools.length > max) {
      var more = document.createElement("div");
      more.className = "cmd-palette__more";
      more.textContent = "他 " + (filteredTools.length - max) + " 件";
      list.appendChild(more);
    }
  }

  function updateSelection() {
    var items = list.querySelectorAll(".cmd-palette__item");
    items.forEach(function (item, i) {
      item.classList.toggle("is-selected", i === selectedIndex);
      if (i === selectedIndex) {
        item.scrollIntoView({ block: "nearest" });
      }
    });
  }

  function navigateToTool(slug) {
    closePalette();
    window.location.href = getBasePath() + slug + "/";
  }

  function openPalette() {
    if (isOpen) return;
    createPalette();
    isOpen = true;
    palette.parentElement.classList.add("is-open");
    input.value = "";
    filterTools("");
    requestAnimationFrame(function () {
      input.focus();
    });
  }

  function closePalette() {
    if (!isOpen || !palette) return;
    isOpen = false;
    palette.parentElement.classList.remove("is-open");
  }

  // Global keyboard shortcut
  document.addEventListener("keydown", function (e) {
    // Cmd+K (Mac) or Ctrl+K (Windows/Linux)
    if ((e.metaKey || e.ctrlKey) && e.key === "k") {
      e.preventDefault();
      if (isOpen) {
        closePalette();
      } else {
        openPalette();
      }
    }

    if (e.key === "Escape" && isOpen) {
      closePalette();
    }
  });

  // Expose for external use
  window.DevToolBox = window.DevToolBox || {};
  window.DevToolBox.openCommandPalette = openPalette;
})();
