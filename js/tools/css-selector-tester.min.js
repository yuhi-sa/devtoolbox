"use strict";
(function(){
document.addEventListener("DOMContentLoaded",function(){
var htmlInput=document.getElementById("html-input");
var selectorInput=document.getElementById("selector-input");
var selectorError=document.getElementById("selector-error");
var matchCount=document.getElementById("match-count");
var matchResults=document.getElementById("match-results");
var htmlPreview=document.getElementById("html-preview");
var btnTest=document.getElementById("btn-test");
var btnClear=document.getElementById("btn-clear");
function showError(msg){selectorError.textContent=msg;selectorError.hidden=false;matchCount.hidden=true;}
function clearMessages(){selectorError.hidden=true;matchCount.hidden=true;}
function escapeHtml(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function getElementDescription(el){var desc=el.tagName.toLowerCase();if(el.id)desc+="#"+el.id;if(el.className){var classes=el.className.split(/\s+/).filter(function(c){return c;});for(var i=0;i<classes.length;i++){desc+="."+classes[i];}}return desc;}
function getTextPreview(el){var text=el.textContent||"";text=text.replace(/\s+/g," ").trim();if(text.length>60)text=text.substring(0,60)+"...";return text;}
function serializeWithHighlight(node,matchedSet){if(node.nodeType===3){return escapeHtml(node.textContent);}if(node.nodeType!==1)return"";var tag=node.tagName.toLowerCase();var isMatch=matchedSet.has(node);var html="";if(isMatch){html+='<span style="background: rgba(255, 213, 79, 0.4); border: 1px solid #ffc107; border-radius: 2px;">';}html+="&lt;"+tag;for(var i=0;i<node.attributes.length;i++){var attr=node.attributes[i];html+=" "+escapeHtml(attr.name)+'="'+escapeHtml(attr.value)+'"';}var voidElements=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"];if(voidElements.indexOf(tag)!==-1){html+=" /&gt;";if(isMatch)html+="</span>";return html;}html+="&gt;";var children=node.childNodes;for(var c=0;c<children.length;c++){html+=serializeWithHighlight(children[c],matchedSet);}html+="&lt;/"+tag+"&gt;";if(isMatch)html+="</span>";return html;}
function runTest(){clearMessages();var htmlStr=htmlInput.value.trim();var selector=selectorInput.value.trim();if(!htmlStr){showError("HTMLを入力してください。");return;}if(!selector){showError("CSSセレクターを入力してください。");return;}var parser=new DOMParser();var doc=parser.parseFromString(htmlStr,"text/html");var body=doc.body;var matched;try{matched=body.querySelectorAll(selector);}catch(e){showError("無効なCSSセレクター: "+e.message);matchResults.innerHTML='<p style="color: var(--color-text-secondary, #666);">セレクターを修正してください。</p>';htmlPreview.textContent="";return;}var count=matched.length;matchCount.textContent="マッチした要素: "+count+"件";matchCount.hidden=false;if(count===0){matchResults.innerHTML='<p style="color: var(--color-text-secondary, #666);">マッチする要素がありません。</p>';}else{var html="";for(var i=0;i<matched.length;i++){var el=matched[i];var desc=getElementDescription(el);var preview=getTextPreview(el);html+='<div style="display: flex; align-items: baseline; gap: 0.75rem; padding: 0.4rem 0; border-bottom: 1px solid var(--color-border, #eee);">';html+='<span style="display: inline-block; min-width: 24px; text-align: center; padding: 0.15rem 0.4rem; border-radius: 4px; background: var(--color-primary, #1a73e8); color: #fff; font-size: 0.75rem; font-weight: bold;">'+(i+1)+"</span>";html+='<code style="font-weight: 600; color: var(--color-primary, #1a73e8);">'+escapeHtml(desc)+"</code>";if(preview){html+='<span style="color: var(--color-text-secondary, #666); font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">"'+escapeHtml(preview)+'"</span>';}html+="</div>";}matchResults.innerHTML=html;}var matchedSet=new Set();for(var j=0;j<matched.length;j++){matchedSet.add(matched[j]);}var previewHtml="";var bodyChildren=body.childNodes;for(var k=0;k<bodyChildren.length;k++){previewHtml+=serializeWithHighlight(bodyChildren[k],matchedSet);}htmlPreview.innerHTML=previewHtml;}
btnTest.addEventListener("click",runTest);
btnClear.addEventListener("click",function(){htmlInput.value="";selectorInput.value="";matchResults.innerHTML='<p style="color: var(--color-text-secondary, #666);">CSSセレクターを入力して「テスト」をクリックしてください。</p>';htmlPreview.innerHTML="";clearMessages();});
var examples=document.querySelectorAll(".selector-example");
for(var i=0;i<examples.length;i++){examples[i].addEventListener("click",function(){selectorInput.value=this.getAttribute("data-selector");});}
});
})();