"use strict";
(function(){
document.addEventListener("DOMContentLoaded",function(){
var inputEl=document.getElementById("yaml-input");
var outputEl=document.getElementById("yaml-output");
var errorEl=document.getElementById("yaml-error");
var successEl=document.getElementById("yaml-success");
var btnValidate=document.getElementById("btn-validate");
var btnFormat=document.getElementById("btn-format");
var btnClear=document.getElementById("btn-clear");
var btnCopy=document.getElementById("btn-copy");
function showError(msg){errorEl.textContent=msg;errorEl.hidden=false;successEl.hidden=true;}
function showSuccess(msg){successEl.textContent=msg;successEl.hidden=false;errorEl.hidden=true;}
function clearMessages(){errorEl.hidden=true;successEl.hidden=true;}
function parseYAML(text){
var lines=text.split("\n");
for(var i=0;i<lines.length;i++){if(/\t/.test(lines[i])){throw new YAMLError("タブ文字が検出されました。YAMLではインデントにスペースのみ使用できます。",i+1);}}
var ctx={lines:lines,pos:0};return parseDocument(ctx);
}
function YAMLError(message,line){this.message=message;this.line=line;}
YAMLError.prototype=new Error();
function parseDocument(ctx){
skipBlankAndComments(ctx);
if(ctx.pos>=ctx.lines.length)return null;
var line=ctx.lines[ctx.pos];var stripped=line.replace(/#.*$/,"").trimEnd();
if(stripped==="---"){ctx.pos++;skipBlankAndComments(ctx);}
if(ctx.pos>=ctx.lines.length)return null;
var result=parseValue(ctx,0);
skipBlankAndComments(ctx);
if(ctx.pos<ctx.lines.length){var endLine=ctx.lines[ctx.pos].trim();if(endLine==="..."||endLine==="---"){ctx.pos++;}}
return result;
}
function skipBlankAndComments(ctx){while(ctx.pos<ctx.lines.length){var line=ctx.lines[ctx.pos];var trimmed=line.trim();if(trimmed===""||trimmed.charAt(0)==="#"){ctx.pos++;}else{break;}}}
function getIndent(line){var match=line.match(/^( *)/);return match?match[1].length:0;}
function parseValue(ctx,expectedIndent){
skipBlankAndComments(ctx);
if(ctx.pos>=ctx.lines.length)return null;
var line=ctx.lines[ctx.pos];var indent=getIndent(line);var trimmed=line.trim();
var contentForCheck=removeInlineComment(trimmed);
if(contentForCheck.match(/^- /)){return parseArray(ctx,indent);}
if(contentForCheck==="-"){return parseArray(ctx,indent);}
if(contentForCheck.match(/^[^\s].*?:\s/)||contentForCheck.match(/^[^\s].*?:$/)||contentForCheck.match(/^".*?":\s/)||contentForCheck.match(/^".*?":$/)||contentForCheck.match(/^'.*?':\s/)||contentForCheck.match(/^'.*?':$/)){return parseMapping(ctx,indent);}
if(contentForCheck.charAt(0)==="["){ctx.pos++;return parseFlowSequence(contentForCheck);}
if(contentForCheck.charAt(0)==="{"){ctx.pos++;return parseFlowMapping(contentForCheck);}
ctx.pos++;return parseScalar(contentForCheck);
}
function removeInlineComment(str){
var inSingle=false;var inDouble=false;
for(var i=0;i<str.length;i++){var ch=str.charAt(i);if(ch==="'"&&!inDouble)inSingle=!inSingle;if(ch==='"'&&!inSingle)inDouble=!inDouble;if(ch==="#"&&!inSingle&&!inDouble&&i>0&&str.charAt(i-1)===" "){return str.substring(0,i).trimEnd();}}
return str;
}
function parseScalar(str){
str=str.trim();
if(str===""||str==="~"||str==="null"||str==="Null"||str==="NULL")return null;
if(str==="true"||str==="True"||str==="TRUE"||str==="yes"||str==="Yes"||str==="YES"||str==="on"||str==="On"||str==="ON")return true;
if(str==="false"||str==="False"||str==="FALSE"||str==="no"||str==="No"||str==="NO"||str==="off"||str==="Off"||str==="OFF")return false;
if((str.charAt(0)==='"'&&str.charAt(str.length-1)==='"')||(str.charAt(0)==="'"&&str.charAt(str.length-1)==="'")){return str.substring(1,str.length-1);}
if(/^-?(\d+\.?\d*|\.\d+)([eE][+-]?\d+)?$/.test(str)){var num=parseFloat(str);if(!isNaN(num))return num;}
if(/^0x[0-9a-fA-F]+$/.test(str))return parseInt(str,16);
if(/^0o[0-7]+$/.test(str))return parseInt(str.substring(2),8);
if(str===".inf"||str===".Inf"||str===".INF")return Infinity;
if(str==="-.inf"||str==="-.Inf"||str==="-.INF")return-Infinity;
if(str===".nan"||str===".NaN"||str===".NAN")return NaN;
return str;
}
function parseFlowSequence(str){
str=str.trim();
if(str.charAt(0)!=="[")throw new YAMLError("フロー配列の構文エラー",0);
if(str.charAt(str.length-1)!=="]")throw new YAMLError("フロー配列が閉じられていません",0);
var inner=str.substring(1,str.length-1).trim();
if(inner==="")return[];
var items=splitFlow(inner);
return items.map(function(item){item=item.trim();if(item.charAt(0)==="[")return parseFlowSequence(item);if(item.charAt(0)==="{")return parseFlowMapping(item);return parseScalar(item);});
}
function parseFlowMapping(str){
str=str.trim();
if(str.charAt(0)!=="{")throw new YAMLError("フローマッピングの構文エラー",0);
if(str.charAt(str.length-1)!=="}")throw new YAMLError("フローマッピングが閉じられていません",0);
var inner=str.substring(1,str.length-1).trim();
if(inner==="")return{};
var items=splitFlow(inner);var obj={};
for(var i=0;i<items.length;i++){var pair=items[i].trim();var colonIdx=pair.indexOf(":");if(colonIdx===-1)throw new YAMLError("フローマッピングのキー:値が不正です",0);var key=pair.substring(0,colonIdx).trim();var val=pair.substring(colonIdx+1).trim();if((key.charAt(0)==='"'&&key.charAt(key.length-1)==='"')||(key.charAt(0)==="'"&&key.charAt(key.length-1)==="'")){key=key.substring(1,key.length-1);}if(val.charAt(0)==="[")obj[key]=parseFlowSequence(val);else if(val.charAt(0)==="{")obj[key]=parseFlowMapping(val);else obj[key]=parseScalar(val);}
return obj;
}
function splitFlow(str){
var items=[];var depth=0;var current="";var inSingle=false;var inDouble=false;
for(var i=0;i<str.length;i++){var ch=str.charAt(i);if(ch==="'"&&!inDouble)inSingle=!inSingle;if(ch==='"'&&!inSingle)inDouble=!inDouble;if(!inSingle&&!inDouble){if(ch==="["||ch==="{")depth++;if(ch==="]"||ch==="}")depth--;if(ch===","&&depth===0){items.push(current);current="";continue;}}current+=ch;}
if(current.trim())items.push(current);return items;
}
function parseMapping(ctx,baseIndent){
var obj={};
while(ctx.pos<ctx.lines.length){
skipBlankAndComments(ctx);if(ctx.pos>=ctx.lines.length)break;
var line=ctx.lines[ctx.pos];var indent=getIndent(line);
if(indent<baseIndent)break;
if(indent>baseIndent){throw new YAMLError("インデントが不正です。",ctx.pos+1);}
var trimmed=line.trim();var content=removeInlineComment(trimmed);
var colonMatch=content.match(/^("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'|[^:]+?):\s*(.*)/);
var colonMatchEmpty=content.match(/^("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'|[^:]+?):$/);
if(!colonMatch&&!colonMatchEmpty)break;
var key,valueStr;
if(colonMatch){key=colonMatch[1].trim();valueStr=colonMatch[2].trim();}else{key=colonMatchEmpty[1].trim();valueStr="";}
if((key.charAt(0)==='"'&&key.charAt(key.length-1)==='"')||(key.charAt(0)==="'"&&key.charAt(key.length-1)==="'")){key=key.substring(1,key.length-1);}
ctx.pos++;
if(valueStr===""||valueStr==="~"||valueStr==="null"){
skipBlankAndComments(ctx);
if(ctx.pos<ctx.lines.length){var nextIndent=getIndent(ctx.lines[ctx.pos]);var nextTrimmed=ctx.lines[ctx.pos].trim();if(nextIndent>baseIndent&&nextTrimmed!==""){obj[key]=parseValue(ctx,nextIndent);continue;}}
obj[key]=(valueStr===""&&colonMatch)?parseScalar(valueStr):null;
}else if(valueStr==="|"||valueStr===">"||valueStr==="|-"||valueStr===">-"||valueStr==="|+"||valueStr===">+"){
obj[key]=parseBlockScalar(ctx,baseIndent,valueStr);
}else if(valueStr.charAt(0)==="["){obj[key]=parseFlowSequence(valueStr);
}else if(valueStr.charAt(0)==="{"){obj[key]=parseFlowMapping(valueStr);
}else{obj[key]=parseScalar(valueStr);}
}
return obj;
}
function parseArray(ctx,baseIndent){
var arr=[];
while(ctx.pos<ctx.lines.length){
skipBlankAndComments(ctx);if(ctx.pos>=ctx.lines.length)break;
var line=ctx.lines[ctx.pos];var indent=getIndent(line);
if(indent<baseIndent)break;if(indent>baseIndent)break;
var trimmed=line.trim();var content=removeInlineComment(trimmed);
if(!content.match(/^-\s?/))break;
var after=content.replace(/^-\s?/,"");ctx.pos++;
if(after===""||after==="~"||after==="null"){
skipBlankAndComments(ctx);
if(ctx.pos<ctx.lines.length){var nextIndent=getIndent(ctx.lines[ctx.pos]);if(nextIndent>baseIndent){arr.push(parseValue(ctx,nextIndent));continue;}}
arr.push(after===""?null:parseScalar(after));
}else if(after.match(/^[^\s].*?:\s/)||after.match(/^[^\s].*?:$/)){
var tempCtx={lines:[after],pos:0};var inlineObj=parseMapping(tempCtx,0);
skipBlankAndComments(ctx);
if(ctx.pos<ctx.lines.length){var ni=getIndent(ctx.lines[ctx.pos]);if(ni>baseIndent){var nested=parseMapping(ctx,ni);for(var nk in nested){if(nested.hasOwnProperty(nk))inlineObj[nk]=nested[nk];}}}
arr.push(inlineObj);
}else if(after.charAt(0)==="["){arr.push(parseFlowSequence(after));
}else if(after.charAt(0)==="{"){arr.push(parseFlowMapping(after));
}else if(after==="|"||after===">"||after==="|-"||after===">-"||after==="|+"||after===">+"){arr.push(parseBlockScalar(ctx,baseIndent,after));
}else{arr.push(parseScalar(after));}
}
return arr;
}
function parseBlockScalar(ctx,parentIndent,indicator){
var lines=[];var blockIndent=-1;var isLiteral=indicator.charAt(0)==="|";var chomp=indicator.length>1?indicator.charAt(1):"";
while(ctx.pos<ctx.lines.length){
var line=ctx.lines[ctx.pos];var trimmed=line.trim();
if(trimmed===""){lines.push("");ctx.pos++;continue;}
var indent=getIndent(line);
if(blockIndent===-1){if(indent<=parentIndent)break;blockIndent=indent;}
if(indent<blockIndent)break;
lines.push(line.substring(blockIndent));ctx.pos++;
}
if(chomp==="-"){while(lines.length>0&&lines[lines.length-1]==="")lines.pop();}
var result;
if(isLiteral){result=lines.join("\n");
}else{var parts=[];var current="";for(var i=0;i<lines.length;i++){if(lines[i]===""){if(current)parts.push(current);parts.push("");current="";}else{current=current?(current+" "+lines[i]):lines[i];}}if(current)parts.push(current);result=parts.join("\n");}
if(chomp==="+"){result+="\n";}
return result;
}
function formatYAML(data,indent){
if(indent===undefined)indent=0;
var prefix=repeatStr("  ",indent);
if(data===null)return"null";
if(data===true)return"true";
if(data===false)return"false";
if(typeof data==="number"){if(data!==data)return".nan";if(data===Infinity)return".inf";if(data===-Infinity)return"-.inf";return String(data);}
if(typeof data==="string"){return formatString(data);}
if(Array.isArray(data)){
if(data.length===0)return"[]";
var lines=[];
for(var i=0;i<data.length;i++){
var val=data[i];
if(val!==null&&typeof val==="object"&&!Array.isArray(val)){
var keys=Object.keys(val);
if(keys.length>0){
var first=true;
for(var j=0;j<keys.length;j++){
var k=keys[j];var v=formatYAML(val[k],indent+2);
if(first){if(val[k]!==null&&typeof val[k]==="object"){lines.push(prefix+"- "+formatKey(k)+":");lines.push(v.split("\n").map(function(l){return prefix+"    "+l;}).join("\n"));}else{lines.push(prefix+"- "+formatKey(k)+": "+v);}first=false;
}else{if(val[k]!==null&&typeof val[k]==="object"){lines.push(prefix+"  "+formatKey(k)+":");lines.push(v.split("\n").map(function(l){return prefix+"    "+l;}).join("\n"));}else{lines.push(prefix+"  "+formatKey(k)+": "+v);}}}
continue;}}
var formatted=formatYAML(val,indent+1);
if(val!==null&&typeof val==="object"){lines.push(prefix+"-");lines.push(formatted.split("\n").map(function(l){return prefix+"  "+l;}).join("\n"));}else{lines.push(prefix+"- "+formatted);}}
return lines.join("\n");
}
if(typeof data==="object"){
var objectKeys=Object.keys(data);if(objectKeys.length===0)return"{}";var objLines=[];
for(var oi=0;oi<objectKeys.length;oi++){var ok=objectKeys[oi];var ov=data[ok];if(ov!==null&&typeof ov==="object"){objLines.push(prefix+formatKey(ok)+":");var nested=formatYAML(ov,indent+1);objLines.push(nested);}else{objLines.push(prefix+formatKey(ok)+": "+formatYAML(ov,0));}}
return objLines.join("\n");
}
return String(data);
}
function formatKey(key){if(/[:{}\[\],&*?|>!%@`#'"]/.test(key)||key.indexOf(" ")!==-1||key===""){return'"'+key.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"';}return key;}
function formatString(str){
if(str==="")return'""';
if(str.indexOf("\n")!==-1){return'"'+str.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n")+'"';}
if(/^[\s]|[\s]$/.test(str)||/[:{}\[\],&*?|>!%@`#'"]/.test(str)||str==="true"||str==="false"||str==="null"||str==="yes"||str==="no"||str==="True"||str==="False"||str==="Null"||str==="Yes"||str==="No"||/^-?\d+(\.\d+)?$/.test(str)){return'"'+str.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"';}
return str;
}
function repeatStr(str,count){var result="";for(var i=0;i<count;i++)result+=str;return result;}
btnValidate.addEventListener("click",function(){
clearMessages();var input=inputEl.value.trim();
if(!input){showError("YAMLを入力してください。");return;}
try{parseYAML(input);showSuccess("有効なYAMLです。構文エラーはありません。");outputEl.value="";}catch(e){if(e.line){showError("YAML構文エラー（"+e.line+"行目）: "+e.message);}else{showError("YAML構文エラー: "+e.message);}outputEl.value="";}
});
btnFormat.addEventListener("click",function(){
clearMessages();var input=inputEl.value.trim();
if(!input){showError("YAMLを入力してください。");return;}
try{var parsed=parseYAML(input);outputEl.value=formatYAML(parsed,0);showSuccess("整形が完了しました。");}catch(e){if(e.line){showError("YAML構文エラー（"+e.line+"行目）: "+e.message);}else{showError("YAML構文エラー: "+e.message);}outputEl.value="";}
});
btnClear.addEventListener("click",function(){inputEl.value="";outputEl.value="";clearMessages();});
btnCopy.addEventListener("click",function(){var text=outputEl.value;if(!text)return;navigator.clipboard.writeText(text).then(function(){showSuccess("コピーしました。");});});
});
})();
