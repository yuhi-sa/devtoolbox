"use strict";
(function(){
document.addEventListener("DOMContentLoaded",function(){
var versionEl=document.getElementById("compose-version");
var networkEl=document.getElementById("compose-network");
var servicesList=document.getElementById("services-list");
var outputEl=document.getElementById("compose-output");
var successEl=document.getElementById("compose-success");
var btnGenerate=document.getElementById("btn-generate");
var btnClear=document.getElementById("btn-clear");
var btnCopy=document.getElementById("btn-copy");
var btnDownload=document.getElementById("btn-download");
var btnAddService=document.getElementById("btn-add-service");
var serviceCounter=0;
var templates={
nginx:{name:"web",image:"nginx:alpine",ports:"80:80",volumes:"./html:/usr/share/nginx/html:ro",env:"",depends:""},
node:{name:"app",image:"node:20-alpine",ports:"3000:3000",volumes:"./app:/usr/src/app",env:"NODE_ENV=production",depends:""},
python:{name:"app",image:"python:3.12-slim",ports:"8000:8000",volumes:"./app:/app",env:"PYTHONUNBUFFERED=1",depends:""},
go:{name:"app",image:"golang:1.22-alpine",ports:"8080:8080",volumes:"./app:/app",env:"GO_ENV=production",depends:""},
mysql:{name:"db",image:"mysql:8.0",ports:"3306:3306",volumes:"db_data:/var/lib/mysql",env:"MYSQL_ROOT_PASSWORD=rootpass\nMYSQL_DATABASE=mydb\nMYSQL_USER=user\nMYSQL_PASSWORD=password",depends:""},
postgres:{name:"db",image:"postgres:16-alpine",ports:"5432:5432",volumes:"db_data:/var/lib/postgresql/data",env:"POSTGRES_DB=mydb\nPOSTGRES_USER=user\nPOSTGRES_PASSWORD=password",depends:""},
mongodb:{name:"db",image:"mongo:7",ports:"27017:27017",volumes:"db_data:/data/db",env:"MONGO_INITDB_ROOT_USERNAME=root\nMONGO_INITDB_ROOT_PASSWORD=rootpass",depends:""},
redis:{name:"cache",image:"redis:7-alpine",ports:"6379:6379",volumes:"redis_data:/data",env:"",depends:""},
memcached:{name:"cache",image:"memcached:1.6-alpine",ports:"11211:11211",volumes:"",env:"",depends:""},
rabbitmq:{name:"queue",image:"rabbitmq:3-management-alpine",ports:"5672:5672\n15672:15672",volumes:"rabbitmq_data:/var/lib/rabbitmq",env:"RABBITMQ_DEFAULT_USER=guest\nRABBITMQ_DEFAULT_PASS=guest",depends:""}
};
function showSuccess(msg){
successEl.textContent=msg;
successEl.hidden=false;
setTimeout(function(){successEl.hidden=true;},2000);
}
function addService(tpl){
serviceCounter++;
var id=serviceCounter;
var t=tpl||{name:"service"+id,image:"",ports:"",volumes:"",env:"",depends:""};
var allNames=getAllServiceNames();
var name=t.name;
if(allNames.indexOf(name)!==-1){
var suffix=2;
while(allNames.indexOf(name+suffix)!==-1)suffix++;
name=name+suffix;
}
var card=document.createElement("div");
card.className="tool-input";
card.style.border="1px solid var(--color-border, #ddd)";
card.style.borderRadius="8px";
card.style.padding="1rem";
card.style.marginBottom="1rem";
card.dataset.serviceId=id;
card.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;">'+'<strong>サービス #'+id+'</strong>'+'<button type="button" class="btn btn--secondary" data-remove="'+id+'" style="padding:.25rem .5rem;font-size:.85rem;">削除</button>'+'</div>'+'<div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;">'+'<div><label class="label">サービス名</label><input type="text" class="input" data-field="name" value="'+escapeAttr(name)+'"></div>'+'<div><label class="label">イメージ</label><input type="text" class="input" data-field="image" value="'+escapeAttr(t.image)+'" placeholder="例: nginx:alpine"></div>'+'</div>'+'<div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem;">'+'<div><label class="label">ポート（1行に1つ）</label><textarea class="textarea" data-field="ports" rows="2" placeholder="8080:80">'+escapeHtml(t.ports)+'</textarea></div>'+'<div><label class="label">ボリューム（1行に1つ）</label><textarea class="textarea" data-field="volumes" rows="2" placeholder="./data:/data">'+escapeHtml(t.volumes)+'</textarea></div>'+'</div>'+'<div style="margin-top:.75rem;"><label class="label">環境変数（1行に1つ、KEY=VALUE）</label><textarea class="textarea" data-field="env" rows="3" placeholder="KEY=value">'+escapeHtml(t.env)+'</textarea></div>'+'<div style="margin-top:.75rem;"><label class="label">depends_on（カンマ区切り）</label><input type="text" class="input" data-field="depends" value="'+escapeAttr(t.depends)+'" placeholder="例: db, cache"></div>';
servicesList.appendChild(card);
card.querySelector('[data-remove="'+id+'"]').addEventListener("click",function(){
card.remove();
});
}
function escapeAttr(s){
return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
function escapeHtml(s){
return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
function getAllServiceNames(){
var names=[];
var cards=servicesList.querySelectorAll("[data-service-id]");
for(var i=0;i<cards.length;i++){
var nameInput=cards[i].querySelector('[data-field="name"]');
if(nameInput&&nameInput.value.trim()){
names.push(nameInput.value.trim());
}
}
return names;
}
function getServices(){
var services=[];
var cards=servicesList.querySelectorAll("[data-service-id]");
for(var i=0;i<cards.length;i++){
var card=cards[i];
var svc={};
svc.name=card.querySelector('[data-field="name"]').value.trim();
svc.image=card.querySelector('[data-field="image"]').value.trim();
svc.ports=parseLines(card.querySelector('[data-field="ports"]').value);
svc.volumes=parseLines(card.querySelector('[data-field="volumes"]').value);
svc.env=parseEnv(card.querySelector('[data-field="env"]').value);
svc.depends=parseDeps(card.querySelector('[data-field="depends"]').value);
if(svc.name&&svc.image)services.push(svc);
}
return services;
}
function parseLines(text){
if(!text)return[];
return text.split("\n").map(function(l){return l.trim();}).filter(function(l){return l;});
}
function parseEnv(text){
if(!text)return{};
var env={};
text.split("\n").forEach(function(line){
line=line.trim();
if(!line)return;
var idx=line.indexOf("=");
if(idx>0){
env[line.substring(0,idx)]=line.substring(idx+1);
}
});
return env;
}
function parseDeps(text){
if(!text)return[];
return text.split(",").map(function(s){return s.trim();}).filter(function(s){return s;});
}
function indent(level){
var s="";
for(var i=0;i<level*2;i++)s+=" ";
return s;
}
function yamlValue(val){
if(/^[\d.]+$/.test(val)||val==="true"||val==="false"||val==="null"||val===""||/[:{}\[\],&*#?|<>=!%@`'"]/.test(val)||/^\s|\s$/.test(val)){
return'"'+val.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"';
}
return val;
}
function generateYaml(){
var services=getServices();
if(services.length===0)return"";
var version=versionEl.value;
var useNetwork=networkEl.checked;
var lines=[];
var namedVolumes=[];
lines.push("# Docker Compose V2ではversion指定は不要ですが、下位互換性のために含めています");
lines.push("version: \""+version+"\"");
lines.push("");
lines.push("# WARNING: デフォルトのパスワードは必ず変更してからデプロイしてください");
lines.push("services:");
for(var i=0;i<services.length;i++){
var svc=services[i];
lines.push(indent(1)+svc.name+":");
lines.push(indent(2)+"image: "+svc.image);
if(svc.ports.length>0){
lines.push(indent(2)+"ports:");
for(var p=0;p<svc.ports.length;p++){
lines.push(indent(3)+'- "'+svc.ports[p]+'"');
}
}
if(svc.volumes.length>0){
lines.push(indent(2)+"volumes:");
for(var v=0;v<svc.volumes.length;v++){
lines.push(indent(3)+"- "+svc.volumes[v]);
var volName=svc.volumes[v].split(":")[0];
if(volName&&volName.indexOf("/")===-1&&volName.indexOf(".")===-1){
if(namedVolumes.indexOf(volName)===-1)namedVolumes.push(volName);
}
}
}
var envKeys=Object.keys(svc.env);
if(envKeys.length>0){
lines.push(indent(2)+"environment:");
for(var e=0;e<envKeys.length;e++){
lines.push(indent(3)+envKeys[e]+": "+yamlValue(svc.env[envKeys[e]]));
}
}
if(svc.depends.length>0){
lines.push(indent(2)+"depends_on:");
for(var d=0;d<svc.depends.length;d++){
lines.push(indent(3)+"- "+svc.depends[d]);
}
}
if(useNetwork){
lines.push(indent(2)+"networks:");
lines.push(indent(3)+"- app-network");
}
lines.push(indent(2)+"restart: unless-stopped");
lines.push("");
}
if(namedVolumes.length>0){
lines.push("volumes:");
for(var n=0;n<namedVolumes.length;n++){
lines.push(indent(1)+namedVolumes[n]+":");
}
lines.push("");
}
if(useNetwork){
lines.push("networks:");
lines.push(indent(1)+"app-network:");
lines.push(indent(2)+"driver: bridge");
lines.push("");
}
return lines.join("\n");
}
var tplButtons=document.querySelectorAll("[data-template]");
for(var i=0;i<tplButtons.length;i++){
tplButtons[i].addEventListener("click",function(){
var key=this.getAttribute("data-template");
if(templates[key]){
addService(templates[key]);
}
});
}
btnAddService.addEventListener("click",function(){
addService(null);
});
btnGenerate.addEventListener("click",function(){
var yaml=generateYaml();
if(!yaml){
outputEl.value="";
return;
}
outputEl.value=yaml;
showSuccess("docker-compose.ymlを生成しました。");
});
btnClear.addEventListener("click",function(){
servicesList.innerHTML="";
outputEl.value="";
serviceCounter=0;
});
btnCopy.addEventListener("click",function(){
var text=outputEl.value;
if(!text)return;
navigator.clipboard.writeText(text).then(function(){
showSuccess("コピーしました。");
});
});
btnDownload.addEventListener("click",function(){
var text=outputEl.value;
if(!text)return;
var blob=new Blob([text],{type:"text/yaml"});
var url=URL.createObjectURL(blob);
var a=document.createElement("a");
a.href=url;
a.download="docker-compose.yml";
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
showSuccess("ダウンロードしました。");
});
});
})();