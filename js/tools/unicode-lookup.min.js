"use strict";
(function(){
document.addEventListener("DOMContentLoaded",function(){
var inputEl=document.getElementById("uni-input");
var errorEl=document.getElementById("uni-error");
var successEl=document.getElementById("uni-success");
var resultEl=document.getElementById("uni-result");
var singleEl=document.getElementById("uni-single");
var stringEl=document.getElementById("uni-string");
var tbodyEl=document.getElementById("uni-tbody");
var tableWrap=document.getElementById("uni-table-wrap");
var blockResult=document.getElementById("uni-block-result");
var blockChars=document.getElementById("uni-block-chars");
var btnLookup=document.getElementById("btn-lookup");
var btnClear=document.getElementById("btn-clear");
var btnAnalyze=document.getElementById("btn-analyze");
function showError(msg){errorEl.textContent=msg;errorEl.hidden=false;successEl.hidden=true;}
function showSuccess(msg){successEl.textContent=msg;successEl.hidden=false;errorEl.hidden=true;}
function clearMessages(){errorEl.hidden=true;successEl.hidden=true;}
function getCodePoints(str){var cps=[];for(var i=0;i<str.length;i++){var code=str.codePointAt(i);cps.push(code);if(code>0xFFFF)i++;}return cps;}
function formatCodepoint(cp){var hex=cp.toString(16).toUpperCase();while(hex.length<4)hex="0"+hex;return"U+"+hex;}
function getUtf8Bytes(cp){
var bytes=[];
if(cp<=0x7F){bytes.push(cp);}
else if(cp<=0x7FF){bytes.push(0xC0|(cp>>6));bytes.push(0x80|(cp&0x3F));}
else if(cp<=0xFFFF){bytes.push(0xE0|(cp>>12));bytes.push(0x80|((cp>>6)&0x3F));bytes.push(0x80|(cp&0x3F));}
else{bytes.push(0xF0|(cp>>18));bytes.push(0x80|((cp>>12)&0x3F));bytes.push(0x80|((cp>>6)&0x3F));bytes.push(0x80|(cp&0x3F));}
return bytes.map(function(b){var h=b.toString(16).toUpperCase();return h.length<2?"0"+h:h;}).join(" ");
}
function getUtf16Units(cp){if(cp<=0xFFFF){var h=cp.toString(16).toUpperCase();while(h.length<4)h="0"+h;return h;}var offset=cp-0x10000;var high=0xD800+(offset>>10);var low=0xDC00+(offset&0x3FF);return high.toString(16).toUpperCase()+" "+low.toString(16).toUpperCase();}
function getHtmlEntity(cp){return"&#x"+cp.toString(16).toUpperCase()+";";}
function charFromCodepoint(cp){try{return String.fromCodePoint(cp);}catch(e){return"";}}
function escapeHtml(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function escapeAttr(str){return str.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function buildCharInfo(cp){
var ch=charFromCodepoint(cp);
var style="border:1px solid var(--color-border);border-radius:6px;padding:1rem;margin-bottom:0.5rem;";
var html='<div style="'+style+'">';
html+='<div style="display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;">';
html+='<span style="font-size:3rem;line-height:1;">'+escapeHtml(ch)+'</span><div>';
var rows=[["コードポイント",formatCodepoint(cp)],["UTF-8",getUtf8Bytes(cp)],["UTF-16",getUtf16Units(cp)],["HTMLエンティティ",getHtmlEntity(cp)],["10進数",String(cp)]];
for(var i=0;i<rows.length;i++){html+='<div style="margin-bottom:0.25rem;"><strong>'+rows[i][0]+':</strong> <code style="user-select:all;">'+escapeHtml(rows[i][1])+'</code> <button class="btn btn--secondary copy-val" data-val="'+escapeAttr(rows[i][1])+'" style="padding:0.15rem 0.5rem;font-size:0.75rem;">コピー</button></div>';}
html+='</div></div></div>';return html;
}
function parseInput(val){
val=val.trim();if(!val)return[];
var upMatch=val.match(/^[Uu]\+([0-9A-Fa-f]{1,6})$/);if(upMatch){return[parseInt(upMatch[1],16)];}
var hexMatch=val.match(/^0[xX]([0-9A-Fa-f]{1,6})$/);if(hexMatch){return[parseInt(hexMatch[1],16)];}
var plainHex=val.match(/^([0-9A-Fa-f]{4,6})$/);if(plainHex&&val.length>=4){return[parseInt(plainHex[1],16)];}
return getCodePoints(val);
}
btnLookup.addEventListener("click",function(){
clearMessages();var val=inputEl.value.trim();
if(!val){showError("文字またはコードポイントを入力してください。");resultEl.hidden=true;return;}
var cps=parseInput(val);if(cps.length===0){showError("入力を解析できませんでした。");resultEl.hidden=true;return;}
var html="";for(var i=0;i<cps.length;i++){html+=buildCharInfo(cps[i]);}
singleEl.innerHTML=html;resultEl.hidden=false;attachCopyHandlers(singleEl);
});
btnAnalyze.addEventListener("click",function(){
clearMessages();var val=stringEl.value;if(!val){tableWrap.hidden=true;return;}
var cps=getCodePoints(val);var rows="";
for(var i=0;i<cps.length;i++){var cp=cps[i];var ch=charFromCodepoint(cp);rows+='<tr style="border-bottom:1px solid var(--color-border);">';rows+='<td style="padding:0.5rem;font-size:1.25rem;">'+escapeHtml(ch)+"</td>";rows+='<td style="padding:0.5rem;"><code>'+formatCodepoint(cp)+"</code></td>";rows+='<td style="padding:0.5rem;"><code>'+getUtf8Bytes(cp)+"</code></td>";rows+='<td style="padding:0.5rem;"><code>'+getUtf16Units(cp)+"</code></td>";rows+='<td style="padding:0.5rem;"><code>'+escapeHtml(getHtmlEntity(cp))+"</code></td>";rows+='<td style="padding:0.5rem;text-align:center;"><button class="btn btn--secondary copy-val" data-val="'+formatCodepoint(cp)+'" style="padding:0.15rem 0.5rem;font-size:0.75rem;">コピー</button></td></tr>';}
tbodyEl.innerHTML=rows;tableWrap.hidden=false;attachCopyHandlers(tableWrap);showSuccess(cps.length+"文字を解析しました。");
});
btnClear.addEventListener("click",function(){inputEl.value="";resultEl.hidden=true;singleEl.innerHTML="";clearMessages();});
var blockBtns=document.querySelectorAll(".uni-block");
for(var b=0;b<blockBtns.length;b++){blockBtns[b].addEventListener("click",function(){
var start=parseInt(this.getAttribute("data-start"),16);var end=parseInt(this.getAttribute("data-end"),16);var html="";
for(var cp=start;cp<=end;cp++){var ch=charFromCodepoint(cp);html+='<button class="btn btn--secondary uni-char-btn" data-cp="'+cp+'" style="width:2.5rem;height:2.5rem;padding:0;font-size:1.25rem;cursor:pointer;" title="'+formatCodepoint(cp)+'">'+escapeHtml(ch)+'</button>';}
blockChars.innerHTML=html;blockResult.hidden=false;
var charBtns=blockChars.querySelectorAll(".uni-char-btn");
for(var c=0;c<charBtns.length;c++){charBtns[c].addEventListener("click",function(){var cp=parseInt(this.getAttribute("data-cp"),10);inputEl.value=formatCodepoint(cp);btnLookup.click();window.scrollTo({top:0,behavior:"smooth"});});}
});}
function attachCopyHandlers(container){var btns=container.querySelectorAll(".copy-val");for(var i=0;i<btns.length;i++){btns[i].addEventListener("click",function(){var val=this.getAttribute("data-val");navigator.clipboard.writeText(val).then(function(){showSuccess("コピーしました。");});});}}
inputEl.addEventListener("keydown",function(e){if(e.key==="Enter"){e.preventDefault();btnLookup.click();}});
});
})();
